<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Dashboard</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 20px;
    }
    .card {
        background: #fff;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }
    input[type="text"] {
        padding: 8px;
        font-size: 14px;
        width: 240px;
        max-width: 100%;
    }
    button {
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    th {
        background: #fafafa;
    }
    .qr-img {
        width: 220px;
        height: 220px;
        border: 1px solid #eee;
        background: #fff;
    }
    .muted {
        color: #666;
        font-size: 13px;
    }
</style>
</head>
<body>

<div class="card">
    <div class="row">
        <h2 style="margin: 0;">Teacher Dashboard</h2>
        <a href="{{ url_for('logout') }}" style="margin-left: auto;">Logout</a>
    </div>
</div>

<div class="card">
    <h3 style="margin-top: 0;">Class QR Code</h3>
    <form class="row" method="get" action="{{ url_for('teacher') }}">
        <label for="class">Class</label>
        <input type="text" id="class" name="class" placeholder="Enter class" value="{{ class_name }}">
        <button type="submit">Update QR</button>
    </form>

    <div class="row" style="margin-top: 12px;">
        <img class="qr-img" src="{{ qr_url }}" alt="Class QR">
        <div>
            <div class="muted">Student link</div>
            <input type="text" readonly value="{{ student_url }}" style="width: 320px;">
            {% if geofence_enabled %}
            <div class="muted" style="margin-top: 8px;">
                Location check enabled (radius {{ geofence_radius_m }} meters)
            </div>
            {% else %}
            <div class="muted" style="margin-top: 8px;">
                Location check not configured.
            </div>
            {% endif %}
            <div class="muted" style="margin-top: 8px;">
                Data retention: {{ retention_days }} days
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h3 style="margin-top: 0;">Search by Class + Date</h3>
    <form class="row" method="get" action="{{ url_for('teacher') }}" id="filterForm">
        <input type="text" name="filter_class" placeholder="Class" value="{{ filter_class }}">
        <label style="display:flex;align-items:center;gap:6px;">
            <span class="muted">Date</span>
            <input type="date" name="date_exact" value="{{ date_exact }}">
        </label>
        <button type="submit">Search</button>
        <a href="{{ url_for('teacher') }}">Reset</a>
    </form>
    <div class="muted" style="margin-top: 8px;">
        Tip: Choose one date to view old attendance.
    </div>
</div>

<div class="card">
    <h3 style="margin-top: 0;">Data Controls</h3>
    <div class="row">
        <form method="post" action="{{ url_for('delete_old') }}" onsubmit="return confirm('Delete records older than retention period?');">
            <button type="submit">Delete Old Records</button>
        </form>
        <form method="post" action="{{ url_for('delete_all') }}" onsubmit="return confirm('Delete ALL attendance records?');">
            <button type="submit" style="background:#d32f2f;color:#fff;border:none;">Delete All</button>
        </form>
    </div>
    <div class="row" style="margin-top: 12px;">
        <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="autoRefresh">
            Auto refresh
        </label>
        <select id="refreshInterval">
            <option value="10">10s</option>
            <option value="30" selected>30s</option>
            <option value="60">60s</option>
        </select>
        <button type="button" id="refreshNow">Refresh Now</button>
    </div>
    <div class="muted" style="margin-top: 8px;">
        Use Delete Old to keep only the last {{ retention_days }} days.
    </div>
</div>

<div class="card">
    <h3 style="margin-top: 0;">Override Attendance</h3>
    <form class="row" method="post" action="{{ url_for('override_attendance') }}">
        <input type="text" name="enrollment" placeholder="Enrollment Number" required>
        <input type="text" name="name" placeholder="Student Name" required>
        <input type="text" name="class" placeholder="Class" required>
        <button type="submit">Mark Override</button>
    </form>
    <div class="muted" style="margin-top: 8px;">
        Use this when a student cannot access their phone.
    </div>
</div>

<div class="card">
    <h3 style="margin-top: 0;">Attendance Records</h3>
    <table>
        <tr>
            <th>Enrollment</th>
            <th>Name</th>
            <th>Class</th>
            <th>Time</th>
            <th>Status</th>
            <th>Action</th>
        </tr>

        {% for r in rows %}
        <tr>
            <td>{{ r["enrollment"] }}</td>
            <td>{{ r["name"] }}</td>
            <td>{{ r["class"] }}</td>
            <td>{{ r["time"] }}</td>
            <td>{{ r["status"] }}</td>
            <td>
                <a href="{{ url_for('edit_record', row_id=r['id']) }}">Edit</a>
                <form method="post" action="{{ url_for('delete_one', row_id=r['id']) }}" onsubmit="return confirm('Delete this record?');" style="display:inline;">
                    <button type="submit" style="background:#d32f2f;color:#fff;border:none;padding:6px 10px;margin-left:6px;">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<script>
    (function () {
        const checkbox = document.getElementById("autoRefresh");
        const intervalSelect = document.getElementById("refreshInterval");
        const refreshBtn = document.getElementById("refreshNow");
        let timerId = null;

        const savedEnabled = localStorage.getItem("teacherAutoRefresh") === "true";
        const savedInterval = localStorage.getItem("teacherRefreshInterval");

        if (savedInterval) {
            intervalSelect.value = savedInterval;
        }
        checkbox.checked = savedEnabled;

        function schedule() {
            if (timerId) {
                clearInterval(timerId);
                timerId = null;
            }

            localStorage.setItem("teacherAutoRefresh", checkbox.checked ? "true" : "false");
            localStorage.setItem("teacherRefreshInterval", intervalSelect.value);

            if (!checkbox.checked) {
                return;
            }

            const intervalMs = parseInt(intervalSelect.value, 10) * 1000;
            timerId = setInterval(() => {
                window.location.reload();
            }, intervalMs);
        }

        checkbox.addEventListener("change", schedule);
        intervalSelect.addEventListener("change", schedule);
        refreshBtn.addEventListener("click", () => window.location.reload());

        schedule();
    })();
</script>

</body>
</html>
